<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .video-box {
            flex: 1;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/9;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Camera Debug Test</h1>
        <p>This page helps debug camera access issues for Agora video chat.</p>
        
        <div id="status" class="status">Ready to test camera access</div>
        
        <div class="controls">
            <button id="testCamera">üé• Test Camera Access</button>
            <button id="testAgora" disabled>üöÄ Test Agora Video</button>
            <button id="stopAll">‚èπÔ∏è Stop All</button>
        </div>
        
        <div class="video-container">
            <div class="video-box">
                <video id="nativeVideo" autoplay muted playsinline></video>
                <div class="video-label">Native getUserMedia</div>
            </div>
            <div class="video-box">
                <div id="agoraVideo"></div>
                <div class="video-label">Agora Video Track</div>
            </div>
        </div>
        
        <div class="info-grid">
            <div class="info-box">
                <h3>üìä Camera Info</h3>
                <div id="cameraInfo">Not tested yet</div>
            </div>
            <div class="info-box">
                <h3>üåê Browser Info</h3>
                <div id="browserInfo">Loading...</div>
            </div>
        </div>
        
        <h3>üìù Debug Log</h3>
        <div id="log" class="log"></div>
    </div>

    <!-- Agora SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>
    
    <script>
        const testCameraBtn = document.getElementById('testCamera');
        const testAgoraBtn = document.getElementById('testAgora');
        const stopAllBtn = document.getElementById('stopAll');
        const nativeVideo = document.getElementById('nativeVideo');
        const agoraVideoContainer = document.getElementById('agoraVideo');
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const cameraInfoDiv = document.getElementById('cameraInfo');
        const browserInfoDiv = document.getElementById('browserInfo');
        
        let nativeStream = null;
        let agoraVideoTrack = null;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function setStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // Display browser info
        function displayBrowserInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'Platform': navigator.platform,
                'Language': navigator.language,
                'Online': navigator.onLine,
                'Cookies Enabled': navigator.cookieEnabled,
                'Media Devices': !!navigator.mediaDevices,
                'getUserMedia': !!navigator.mediaDevices?.getUserMedia,
                'HTTPS': location.protocol === 'https:',
                'Localhost': location.hostname === 'localhost'
            };
            
            let html = '';
            for (const [key, value] of Object.entries(info)) {
                const icon = value === true ? '‚úÖ' : value === false ? '‚ùå' : 'üìù';
                html += `${icon} ${key}: ${value}<br>`;
            }
            browserInfoDiv.innerHTML = html;
        }
        
        // Test native camera access
        async function testNativeCamera() {
            try {
                log('üé• Testing native camera access...');
                setStatus('Testing camera access...', 'warning');
                
                // Request camera and microphone
                nativeStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: true
                });
                
                nativeVideo.srcObject = nativeStream;
                
                // Get camera info
                const videoTrack = nativeStream.getVideoTracks()[0];
                const audioTrack = nativeStream.getAudioTracks()[0];
                
                const videoSettings = videoTrack.getSettings();
                const audioSettings = audioTrack.getSettings();
                
                let cameraInfo = `üìπ Video Track:<br>`;
                cameraInfo += `   Device: ${videoSettings.deviceId}<br>`;
                cameraInfo += `   Label: ${videoTrack.label}<br>`;
                cameraInfo += `   Resolution: ${videoSettings.width}x${videoSettings.height}<br>`;
                cameraInfo += `   Frame Rate: ${videoSettings.frameRate}<br>`;
                cameraInfo += `<br>üé§ Audio Track:<br>`;
                cameraInfo += `   Device: ${audioSettings.deviceId}<br>`;
                cameraInfo += `   Label: ${audioTrack.label}<br>`;
                cameraInfo += `   Sample Rate: ${audioSettings.sampleRate}<br>`;
                
                cameraInfoDiv.innerHTML = cameraInfo;
                
                log('‚úÖ Native camera access successful');
                log(`üìπ Video: ${videoSettings.width}x${videoSettings.height} @ ${videoSettings.frameRate}fps`);
                log(`üé§ Audio: ${audioTrack.label}`);
                
                setStatus('‚úÖ Camera access successful! Agora test enabled.', 'success');
                testAgoraBtn.disabled = false;
                
            } catch (error) {
                log(`‚ùå Native camera test failed: ${error.message}`);
                setStatus(`‚ùå Camera access failed: ${error.message}`, 'error');
                
                let errorInfo = `‚ùå Error: ${error.name}<br>`;
                errorInfo += `Message: ${error.message}<br><br>`;
                
                if (error.name === 'NotAllowedError') {
                    errorInfo += `üîí Permission denied. Try:<br>`;
                    errorInfo += `1. Click camera icon in address bar<br>`;
                    errorInfo += `2. Allow camera access<br>`;
                    errorInfo += `3. Refresh page<br>`;
                } else if (error.name === 'NotFoundError') {
                    errorInfo += `üìπ No camera found. Try:<br>`;
                    errorInfo += `1. Connect a camera<br>`;
                    errorInfo += `2. Close other camera apps<br>`;
                    errorInfo += `3. Check device manager<br>`;
                } else if (error.name === 'NotReadableError') {
                    errorInfo += `üîí Camera in use. Try:<br>`;
                    errorInfo += `1. Close other apps using camera<br>`;
                    errorInfo += `2. Restart browser<br>`;
                    errorInfo += `3. Restart computer<br>`;
                }
                
                cameraInfoDiv.innerHTML = errorInfo;
            }
        }
        
        // Test Agora video track
        async function testAgoraVideo() {
            try {
                log('üöÄ Testing Agora video track creation...');
                setStatus('Testing Agora video...', 'warning');
                
                if (!window.AgoraRTC) {
                    throw new Error('Agora SDK not loaded');
                }
                
                // Create Agora video track
                agoraVideoTrack = await AgoraRTC.createCameraVideoTrack({
                    width: 640,
                    height: 480,
                    frameRate: 15
                });
                
                // Play Agora video
                agoraVideoTrack.play(agoraVideoContainer);
                
                log('‚úÖ Agora video track created and playing');
                setStatus('‚úÖ Both native and Agora video working!', 'success');
                
            } catch (error) {
                log(`‚ùå Agora video test failed: ${error.message}`);
                setStatus(`‚ùå Agora video failed: ${error.message}`, 'error');
            }
        }
        
        // Stop all streams
        function stopAll() {
            log('‚èπÔ∏è Stopping all streams...');
            
            if (nativeStream) {
                nativeStream.getTracks().forEach(track => track.stop());
                nativeVideo.srcObject = null;
                nativeStream = null;
            }
            
            if (agoraVideoTrack) {
                agoraVideoTrack.stop();
                agoraVideoTrack.close();
                agoraVideoContainer.innerHTML = '';
                agoraVideoTrack = null;
            }
            
            testAgoraBtn.disabled = true;
            setStatus('‚èπÔ∏è All streams stopped', 'info');
            log('‚úÖ All streams stopped successfully');
        }
        
        // Event listeners
        testCameraBtn.addEventListener('click', testNativeCamera);
        testAgoraBtn.addEventListener('click', testAgoraVideo);
        stopAllBtn.addEventListener('click', stopAll);
        
        // Initialize
        displayBrowserInfo();
        log('üîç Camera Debug Test loaded');
        log('üìã Steps: 1) Test Camera Access 2) Test Agora Video 3) Check results');
    </script>
</body>
</html>
