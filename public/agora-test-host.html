<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agora Test - Host (Admin)</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header .role {
            background: #ff6b6b;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .controls input {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            placeholder-color: rgba(255, 255, 255, 0.7);
            min-width: 200px;
        }
        .controls input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .controls button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .controls button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        .controls button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .controls button.danger {
            background: #f44336;
        }
        .controls button.danger:hover {
            background: #da190b;
        }
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .video-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .video-box h3 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }
        .video-box video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            background: #000;
        }
        .status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .status h3 {
            margin: 0 0 15px 0;
            color: #4CAF50;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log h3 {
            margin: 0 0 15px 0;
            color: #ffd700;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }
        @media (max-width: 768px) {
            .video-container {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: center;
            }
            .controls input, .controls button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• Agora Live Video Test</h1>
            <div class="role">üë®‚Äçüíº HOST (Admin)</div>
        </div>

        <div class="controls">
            <input type="text" id="channelName" placeholder="Channel Name" value="test-live-session">
            <input type="text" id="adminEmail" placeholder="Admin Email" value="admin@tcftef.com">
            <input type="password" id="adminPassword" placeholder="Admin Password" value="AdminTest123!">
            <button id="joinBtn">üöÄ Start Live Session</button>
            <button id="leaveBtn" disabled class="danger">üõë End Session</button>
        </div>

        <div class="video-container">
            <div class="video-box">
                <h3>üìπ Your Video (Host)</h3>
                <div id="localVideo"></div>
            </div>
            <div class="video-box">
                <h3>üë• Participants</h3>
                <div id="remoteVideos"></div>
            </div>
        </div>

        <div class="status">
            <h3>üìä Session Status</h3>
            <div class="status-item">
                <span>Connection:</span>
                <span id="connectionStatus">‚ùå Disconnected</span>
            </div>
            <div class="status-item">
                <span>Channel:</span>
                <span id="currentChannel">-</span>
            </div>
            <div class="status-item">
                <span>Participants:</span>
                <span id="participantCount">0</span>
            </div>
            <div class="status-item">
                <span>Role:</span>
                <span>üéØ Host (Publisher)</span>
            </div>
        </div>

        <div class="log">
            <h3>üìù Activity Log</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        // Agora configuration
        let client;
        let localTracks = {
            videoTrack: null,
            audioTrack: null
        };
        let remoteUsers = {};
        let isJoined = false;

        // UI elements
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const channelNameInput = document.getElementById('channelName');
        const adminEmailInput = document.getElementById('adminEmail');
        const adminPasswordInput = document.getElementById('adminPassword');
        const connectionStatus = document.getElementById('connectionStatus');
        const currentChannel = document.getElementById('currentChannel');
        const participantCount = document.getElementById('participantCount');
        const logContainer = document.getElementById('logContainer');

        // Logging function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[HOST] ${message}`);
        }

        // Initialize Agora client
        function initializeAgora() {
            client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
            
            client.on("user-published", handleUserPublished);
            client.on("user-unpublished", handleUserUnpublished);
            client.on("user-joined", handleUserJoined);
            client.on("user-left", handleUserLeft);
            
            log("Agora client initialized");
        }

        // Event handlers
        function handleUserJoined(user) {
            log(`User joined: ${user.uid}`);
            updateParticipantCount();
        }

        function handleUserLeft(user) {
            log(`User left: ${user.uid}`);
            delete remoteUsers[user.uid];
            updateParticipantCount();
        }

        async function handleUserPublished(user, mediaType) {
            await client.subscribe(user, mediaType);
            log(`Subscribed to ${user.uid} ${mediaType}`);

            if (mediaType === 'video') {
                const remoteVideoTrack = user.videoTrack;
                const playerContainer = document.createElement('div');
                playerContainer.id = `player-${user.uid}`;
                playerContainer.style.width = '100%';
                playerContainer.style.height = '200px';
                playerContainer.style.marginBottom = '10px';
                document.getElementById('remoteVideos').appendChild(playerContainer);
                remoteVideoTrack.play(playerContainer);
            }

            if (mediaType === 'audio') {
                user.audioTrack.play();
            }

            remoteUsers[user.uid] = user;
            updateParticipantCount();
        }

        function handleUserUnpublished(user, mediaType) {
            log(`User unpublished ${mediaType}: ${user.uid}`);
            if (mediaType === 'video') {
                const playerContainer = document.getElementById(`player-${user.uid}`);
                if (playerContainer) {
                    playerContainer.remove();
                }
            }
        }

        function updateParticipantCount() {
            const count = Object.keys(remoteUsers).length;
            participantCount.textContent = count;
        }

        // Join channel with enhanced error handling
        async function joinChannel() {
            try {
                log('üöÄ Starting live session...');

                // Check browser compatibility
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Browser does not support camera access. Please use Chrome, Firefox, or Edge.');
                }

                // Check camera permissions first
                log('üîç Checking camera permissions...');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    stream.getTracks().forEach(track => track.stop()); // Stop the test stream
                    log('‚úÖ Camera and microphone permissions granted');
                } catch (permError) {
                    log('‚ùå Camera/microphone permission error:');
                    log(`   ${permError.message}`);
                    if (permError.name === 'NotAllowedError') {
                        alert('Camera access denied. Please:\n1. Click the camera icon in address bar\n2. Allow camera access\n3. Refresh the page');
                    } else if (permError.name === 'NotFoundError') {
                        alert('No camera found. Please:\n1. Connect a camera\n2. Close other apps using camera\n3. Try a different browser');
                    }
                    throw permError;
                }
                const channelName = channelNameInput.value.trim();
                const email = adminEmailInput.value.trim();
                const password = adminPasswordInput.value.trim();

                if (!channelName || !email || !password) {
                    alert('Please fill in all fields');
                    return;
                }

                log('Authenticating admin...');
                
                // Login to get token
                const loginResponse = await fetch('http://localhost:3001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const loginData = await loginResponse.json();
                if (!loginData.success) {
                    throw new Error(loginData.error.message);
                }

                const accessToken = loginData.data.tokens.accessToken;
                log('Admin authenticated successfully');

                // Get RTC token
                const uid = `host-${Date.now()}`;
                const tokenResponse = await fetch('http://localhost:3001/api/agora/rtc/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        channelName,
                        uid,
                        role: 'publisher',
                        expiry: 3600
                    })
                });

                const tokenData = await tokenResponse.json();
                if (!tokenData.success) {
                    throw new Error(tokenData.error.message);
                }

                const rtcToken = tokenData.data.token;
                const appId = tokenData.data.appId;
                log(`RTC token generated for channel: ${channelName}`);

                // Initialize Agora if not already done
                if (!client) {
                    client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                    client.on("user-published", handleUserPublished);
                    client.on("user-unpublished", handleUserUnpublished);
                    client.on("user-joined", handleUserJoined);
                    client.on("user-left", handleUserLeft);
                }

                // Create local tracks with enhanced debugging
                log('üé§ Creating microphone audio track...');
                localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                log('‚úÖ Audio track created successfully');

                log('üìπ Creating camera video track...');

                // Try different video configurations
                const videoConfigs = [
                    { width: 640, height: 480, frameRate: 15 },
                    { width: 320, height: 240, frameRate: 15 },
                    {} // Default config
                ];

                let videoTrackCreated = false;
                for (let i = 0; i < videoConfigs.length; i++) {
                    try {
                        log(`üìπ Trying video config ${i + 1}: ${JSON.stringify(videoConfigs[i])}`);
                        localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack(videoConfigs[i]);
                        log('‚úÖ Video track created successfully');
                        videoTrackCreated = true;
                        break;
                    } catch (videoError) {
                        log(`‚ö†Ô∏è Video config ${i + 1} failed: ${videoError.message}`);
                        if (i === videoConfigs.length - 1) {
                            throw videoError;
                        }
                    }
                }

                if (!videoTrackCreated) {
                    throw new Error('Failed to create video track with any configuration');
                }

                // Play local video with debugging
                log('üé• Playing local video...');
                const localVideoContainer = document.getElementById('localVideo');
                if (!localVideoContainer) {
                    throw new Error('Local video container not found');
                }

                localTracks.videoTrack.play('localVideo');
                log('‚úÖ Local video started successfully');

                // Verify video is actually playing
                setTimeout(() => {
                    const videoElement = localVideoContainer.querySelector('video');
                    if (videoElement) {
                        log(`üìä Video element found: ${videoElement.videoWidth}x${videoElement.videoHeight}`);
                        if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                            log('‚úÖ Video is displaying correctly');
                        } else {
                            log('‚ö†Ô∏è Video element exists but no video data');
                            log('üí° Try: 1) Check camera permissions 2) Close other camera apps 3) Refresh page');
                        }
                    } else {
                        log('‚ùå No video element found in container');
                    }
                }, 2000);

                // Join channel
                log(`Joining channel: ${channelName}`);
                await client.join(appId, channelName, rtcToken, uid);
                
                // Publish local tracks
                await client.publish([localTracks.audioTrack, localTracks.videoTrack]);
                log('Local tracks published');

                isJoined = true;
                connectionStatus.textContent = '‚úÖ Connected';
                currentChannel.textContent = channelName;
                joinBtn.disabled = true;
                leaveBtn.disabled = false;

                log('üéâ Live session started successfully!');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);

                // Provide specific error guidance
                let errorMessage = `Failed to start session: ${error.message}\n\n`;

                if (error.message.includes('Permission denied') || error.message.includes('NotAllowedError')) {
                    errorMessage += 'Camera Permission Issue:\n';
                    errorMessage += '1. Click the camera icon in address bar\n';
                    errorMessage += '2. Allow camera and microphone access\n';
                    errorMessage += '3. Refresh the page and try again';
                } else if (error.message.includes('NotFoundError') || error.message.includes('no camera')) {
                    errorMessage += 'Camera Not Found:\n';
                    errorMessage += '1. Check if camera is connected\n';
                    errorMessage += '2. Close other apps using camera (Zoom, Teams, etc.)\n';
                    errorMessage += '3. Try a different browser';
                } else if (error.message.includes('NotReadableError')) {
                    errorMessage += 'Camera In Use:\n';
                    errorMessage += '1. Close other applications using camera\n';
                    errorMessage += '2. Restart your browser\n';
                    errorMessage += '3. Try incognito/private mode';
                } else if (error.message.includes('OverconstrainedError')) {
                    errorMessage += 'Camera Configuration Issue:\n';
                    errorMessage += '1. Your camera doesn\'t support the requested settings\n';
                    errorMessage += '2. Try a different browser\n';
                    errorMessage += '3. Check camera drivers';
                } else {
                    errorMessage += 'Troubleshooting Steps:\n';
                    errorMessage += '1. Refresh the page\n';
                    errorMessage += '2. Try incognito/private mode\n';
                    errorMessage += '3. Check browser console (F12) for details\n';
                    errorMessage += '4. Try a different browser (Chrome recommended)';
                }

                alert(errorMessage);

                // Reset UI state
                joinBtn.disabled = false;
                leaveBtn.disabled = true;
                connectionStatus.textContent = '‚ùå Connection Failed';
            }
        }

        // Leave channel
        async function leaveChannel() {
            try {
                log('Ending live session...');

                // Stop local tracks
                if (localTracks.audioTrack) {
                    localTracks.audioTrack.stop();
                    localTracks.audioTrack.close();
                    localTracks.audioTrack = null;
                }
                if (localTracks.videoTrack) {
                    localTracks.videoTrack.stop();
                    localTracks.videoTrack.close();
                    localTracks.videoTrack = null;
                }

                // Clear local video
                document.getElementById('localVideo').innerHTML = '';

                // Clear remote videos
                document.getElementById('remoteVideos').innerHTML = '';

                // Leave channel
                if (client && isJoined) {
                    await client.leave();
                }

                remoteUsers = {};
                isJoined = false;
                connectionStatus.textContent = '‚ùå Disconnected';
                currentChannel.textContent = '-';
                updateParticipantCount();
                joinBtn.disabled = false;
                leaveBtn.disabled = true;

                log('‚úÖ Live session ended');

            } catch (error) {
                log(`‚ùå Error leaving: ${error.message}`);
            }
        }

        // Event listeners
        joinBtn.addEventListener('click', joinChannel);
        leaveBtn.addEventListener('click', leaveChannel);

        // Initialize on page load
        log('Host page loaded - Ready to start live session');
    </script>
</body>
</html>
